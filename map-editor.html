<!DOCTYPE html>
<html>
<head>
	<title>play</title>

	<link rel="stylesheet" type="text/css" href="assets/css/map-editor.css">
</head>
<body>
	<div id="play">
		<div class="ui">
			<div class="ui-left">
				Generating Tiles
				<div class="tiles-map">
						<tiles-map :maps="config.tilesMap" :config="config"></tiles-map>
						<active-tile-map :map="config.activeTileMap" v-model="config.activeLayer" :config="config"></active-tile-map>
				</div>

				<div>
					Active Tile:
					<active-brush-tile :tile="config.activeTile"></active-brush-tile>
				</div>

				Select Tile:
				<div class="tile-list">
					<tile v-for="tile in config.tiles" :tile="tile" :config="config"></tile>
				</div>
			</div>
			<div class="ui-right">
				<div>
					Layer:
					<select v-model="config.activeLayer">
						<option value="" selected="selected">Custom</option>
						<option v-for="layer in config.layers" :value="layer">{{ layer }}</option>
					</select>

					Dimensions:
					<input type="number" v-model="config.width" name="" value="config.width" />
					<input type="number" v-model="config.height" name="" value="config.height" />
				</div>
				<div class="map">
					<view-map-row v-for="(row, row_id) in parseInt(config.height)" :row="row" :row_id="row_id" :config="config"></view-map-row>
				</div>
			</div>
		</div>

		<div class="map-config"><pre>{{ config.map }}</pre></div>
	</div>


	<!-- development version, includes helpful console warnings -->
	<script src="//cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script type="text/javascript" src="assets/js/map/config.js"></script>

	<script type="text/javascript">
		Vue.component('activeBrushTile', {
		  props: ['tile'],
		  template: ['<span class="active-brush-tile" :style="getTileStyle" :class="getTileMapClass"></span>',
		    ].join(""),
		  computed: {
		  	getTileStyle: function () {
		  		let data = {}
		  		let tile = this.tile
		  		if (!tile) {
		  			return data
		  		}

		  		// style="width: 16px; height: 16px; background: url(assets/tileset_1.png); background-position: 0 0;"
		  		if (tile['size']) {
		  			data['width'] = tile['size'][0] + 'px'
		  		}
		  		if (tile['size']) {
		  			data['height'] = tile['size'][1] + 'px'
		  		}
		  		if (tile['texture']) {
		  			data['background'] = 'url(' + tile['texture'] + ')'
		  		}
		  		if (tile['offset']) {
		  			data['background-position'] = tile['offset'][0] + 'px ' + tile['offset'][1] + 'px'
		  		}

		  		return data
		  	},
		  	getTileMapClass: function () {
		  		let data = {}
		  		let tile = this.tile

		  		if (!tile) {
		  			return data
		  		}

		  		if (tile['map']) {
		  			data[tile['map']] = true
		  		}

		  		return data
		  	},
		  }
		})

		Vue.component('viewMapRow', {
		  props: ['row', 'row_id', 'config'],
		  template: ['<div class="view-map-row">',
		              '<view-map-tile v-for="(col , col_id) in parseInt(config.width)" :row="row" :row_id="row_id" :col="col" :col_id="col_id" :config="config"></view-map-tile><br />',
		            '</div>'
		    ].join("")
		})

		Vue.component('viewMapTile', {
		  props: ['row_id', 'col_id', 'config'],
		  template: ['<span class="tile" @click="brushCell">',
		  		'<span class="service">{{ row_id }}/{{ col_id }} {{ getTileName }}</span>',
		        '<view-map-tile-layer v-for="tile in getTiles" :tile="tile"></view-map-tile-layer>',
		        '<span class="tile-layers-info">',
		        	'<view-map-tile-layers-info v-for="(tile, idx) in getTiles" :tile="tile" :tiles="getTiles" :idx="idx"></view-map-tile-layers-info>',
		        	'<div style="zoom: 0.3;"><span @click="addLayer">Add Layer +</span>',
		        		'<span @click="removeLayer">Remove Layer -</span>',
		        		'<span @click="removeAllLayers">Remove All Layers -</span>',
		        	'</div>',
		        '</span>',
		      '</span>',
		    '</span>'].join(""),
		  methods: {
		  	brushCell: function () {
		  		if (!config.activeLayer) {
		  			return
		  		}

		  		if (!config.map[this.row_id]) {
		  			Vue.set(config.map, this.row_id, {})
		  		}

		  		if (!config.map[this.row_id][this.col_id]) {
		  			Vue.set(config.map[this.row_id], this.col_id, {})	
		  		}

		  		if (!config.map[this.row_id][this.col_id][config.activeLayer]) {
		  			Vue.set(config.map[this.row_id][this.col_id], config.activeLayer, {})	
		  		}

		  		if (config.activeTile.id == null) {
		  			Vue.delete(config.map[this.row_id][this.col_id], config.activeLayer)
		  		} else {
		  			config.map[this.row_id][this.col_id][config.activeLayer] = config.activeTile
		  		}
		  	},
		  	addLayer: function () {
		  		if (!config.map[this.row_id]) {
		  			Vue.set(config.map, this.row_id, {})
		  		}

		  		if (!config.map[this.row_id][this.col_id]) {
		  			Vue.set(config.map[this.row_id], this.col_id, {})	
		  		}

		  		let layers_count = Object.keys(config.map[this.row_id][this.col_id]).length
		  		// add new layer
		  		console.log(layers_count, config.layers)
		  		if (layers_count < config.layers) {
		  			Vue.set(config.map[this.row_id][this.col_id], layers_count + 1, {})	
		  		}
		  	},
		  	removeLayer: function () {
		  		let layers_count = Object.keys(config.map[this.row_id][this.col_id]).length
		  		// remove layer
		  		if (layers_count > 1) {
		  			Vue.delete(config.map[this.row_id][this.col_id], layers_count)
		  		}
		  	},
		  	removeAllLayers: function () {
		  		Vue.delete(config.map[this.row_id], this.col_id)
		  	}
		  },
		  computed: {
				getInfoCell: function () {
		  		let tiles = {}
		  		if (config.map[this.row_id] && config.map[this.row_id][this.col_id]) {
		  			tiles = config.map[this.row_id][this.col_id]
		  		}

		  		config.hoveredTiles = tiles
		  	},
		  	getTiles: function () {
		  		let tiles = {}
		  		if (config.map[this.row_id] && config.map[this.row_id][this.col_id]) {
		  			tiles = config.map[this.row_id][this.col_id]
		  		}

		  		return tiles
		  	},
		  	getTileName: function () {
		  		if (config.map[this.row_id] && config.map[this.row_id][this.col_id]) {
		  			let tile = config.map[this.row_id][this.col_id]
		  			return tile.id
		  		}

		  		return null
		  	}
		  }
		})

		Vue.component('viewMapTileLayersInfo', {
		  props: ['tile', 'idx', 'tiles'],
		  template: ['<span class="layer" :style="getTileStyle" @click="brushCell" :class="getTileMapClass">{{ idx }}</span>',
		    ].join(""),
		  methods: {
		  	brushCell: function () {
		  		// if selected layer don't brush on selected layer
		  		if (config.activeLayer) {
		  			return
		  		}

		  		if (config.activeTile) {
		  			this.tiles[this.idx] = config.activeTile
		  		}
		  	},
		  },
		  computed: {
		  	getTileStyle: function () {
		  		let data = {}
		  		let tile = this.tile

		  		// style="width: 16px; height: 16px; background: url(assets/tileset_1.png); background-position: 0 0;"
		  		if (tile['size']) {
		  			data['width'] = tile['size'][0] + 'px'
		  		}
		  		if (tile['size']) {
		  			data['height'] = tile['size'][1] + 'px'
		  		}
		  		if (tile['texture']) {
		  			data['background'] = 'url(' + tile['texture'] + ')'
		  		}
		  		if (tile['offset']) {
		  			data['background-position'] = tile['offset'][0] + 'px ' + tile['offset'][1] + 'px'
		  		}

		  		return data
		  	},
		  	getTileMapClass: function () {
		  		let data = {}
		  		let tile = this.tile

		  		if (tile['map']) {
		  			data[tile['map']] = true
		  		}

		  		if (config.activeLayer == this.idx) {
		  			data['active'] = true
		  		}

		  		return data
		  	},
		  }
		})
		Vue.component('viewMapTileLayer', {
		  props: ['tile'],
		  template: ['<span class="layer" :style="getTileStyle" :class="getTileMapClass"></span>',
		    ].join(""),
		  computed: {
		  	getTileStyle: function () {
		  		let data = {}
		  		let tile = this.tile

		  		// style="width: 16px; height: 16px; background: url(assets/tileset_1.png); background-position: 0 0;"
		  		if (tile['size']) {
		  			data['width'] = tile['size'][0] + 'px'
		  		}
		  		if (tile['size']) {
		  			data['height'] = tile['size'][1] + 'px'
		  		}
		  		if (tile['texture']) {
		  			data['background'] = 'url(' + tile['texture'] + ')'
		  		}
		  		if (tile['offset']) {
		  			data['background-position'] = tile['offset'][0] + 'px ' + tile['offset'][1] + 'px'
		  		}

		  		return data
		  	},
		  	getTileMapClass: function () {
		  		let data = {}
		  		let tile = this.tile

		  		if (tile['map']) {
		  			data[tile['map']] = true
		  		}

		  		return data
		  	},
		  }
		})
		Vue.component('tile', {
		  props: ['tile', 'config'],
		  template: ['<span class="tile" :class="isSelected" @click="selectTile">',
		  				'<span class="tile-picture" :style="getTileStyle" :class="getTileMapClass" :title="getTileDetails"></span>',
		  				//'<span class="tile-details">',
		  					//'{{ getTileDetails }}',	
		  				'</span>',
		    '</span>'].join(""),
		  methods: {
		  	selectTile: function () {
		  		config.activeTile = this.tile
		  	},
		  },
	  	computed: {
	  		getTileStyle: function () {
		  		let data = {}
		  		// style="width: 16px; height: 16px; background: url(assets/tileset_1.png); background-position: 0 0;"
		  		if (this.tile['size']) {
		  			data['width'] = this.tile['size'][0] + 'px'
		  		}
		  		if (this.tile['size']) {
		  			data['height'] = this.tile['size'][1] + 'px'
		  		}
		  		// if (this.tile['texture']) {
		  		// 	data['background'] = 'url(' + this.tile['texture'] + ')'
		  		// }
		  		if (this.tile['offset']) {
		  			data['background-position'] = this.tile['offset'][0] + 'px ' + this.tile['offset'][1] + 'px'
		  		}

		  		return data
		  	},
		  	getTileMapClass: function () {
		  		let data = {}
		  		if (this.tile['map']) {
		  			data[this.tile['map']] = true
		  		}

		  		return data
		  	},
		  	isSelected: function () {
		  		let data = {}
		  		if (config.activeTile == this.tile) {
		  			data['active'] = true
		  		}

		  		return data
		  	},
	  		getTileDetails: function () {
	  				return this.tile.id
	  		}
	  	}
		})

		Vue.component('tiles-map', {
		  props: ['maps', 'config'],
		  template: ['<select v-model="config.activeTileMap">',
		  			'<option value="" disabled selected=selected>---</option>',
		  			'<tile-map v-for="map in maps" :map="map"></tile-map>',
		    '</select>'].join(""),
		})

		Vue.component('tile-map', {
		  props: ['map'],
		  template: ['<option :value="map">',
		  			'{{ map.id }}',
		    '</option>'].join(""),
		})

		Vue.component('active-tile-map', {
		  props: ['map', 'config'],
		  template: ['<span>',
		  			'{{ regenerateTiles() }}',
		  			//'{{ map }}',
		    '</span>'].join(""),
		  methods: {
		  	regenerateTiles: function () {
		  		let map = this.map
		  		if (!map) {
		  			return
		  		}
		  		config.tiles = []

		  		let cols = Math.trunc(map.width / map.tileSize[0])
		  		let rows = Math.trunc(map.height / map.tileSize[1])
		  		let map_class = map.class
		  		let tiles = [
						{
							id: null,
							size: [16, 16],
						},
					]

		  		for (let y = 0; y < rows; y++) {
		  			let top_offset = - (map.tileSize[1] * y)
		  			for (let x = 0; x < cols; x++) {
		  				let left_offset = - (map.tileSize[0] * x)
		  				//console.log(left_offset, top_offset)
		  				let tile = {
								id: map_class + top_offset + '_' + left_offset,
								//texture: 'assets/tileset_1.png',
								offset: [left_offset, top_offset],
								size: [map.tileSize[0], map.tileSize[1]],
								position: [0, 0],
								map: map_class
							}

							tiles.push(tile)
		  			}
		  		}

		  		config.tiles = tiles

		  	}
		  }
		})

	</script>

	<script type="text/javascript" src="assets/js/main.js"></script>
</body>
</html>